{"version":3,"file":"react-video.cjs.development.js","sources":["../src/dash.ts","../src/hls.ts","../src/index.tsx"],"sourcesContent":["declare global {\n  interface Window {\n    dashjs: any;\n  }\n}\n\nfunction supportsMediaSource() {\n  let hasWebKit = 'WebKitMediaSource' in window;\n  let hasMediaSource = 'MediaSource' in window;\n\n  return hasWebKit || hasMediaSource;\n}\n\nexport const supportsDash = supportsMediaSource;\n\nlet added = false;\n\nexport function getDash() {\n  return new Promise<any>(resolve => {\n    if (!added) {\n      const hlsCore = document.createElement('script');\n      hlsCore.src = 'https://cdn.dashjs.org/latest/dash.all.min.js';\n      hlsCore.defer = true;\n      document.head.appendChild(hlsCore);\n\n      added = true;\n    }\n\n    (function checkForLibraryExistence() {\n      if ('dashjs' in window) {\n        resolve(window.dashjs);\n      } else {\n        setTimeout(checkForLibraryExistence, 10);\n      }\n    })();\n  });\n}\n","declare global {\n  interface Window {\n    Hls: any;\n  }\n}\n\nlet added = false;\n\nexport function getHls() {\n  return new Promise<any>((resolve) => {\n    if (!added) {\n      const hlsCore = document.createElement('script');\n      hlsCore.src = 'https://cdn.jsdelivr.net/npm/hls.js@latest';\n      hlsCore.defer = true;\n      document.head.appendChild(hlsCore);\n\n      added = true;\n    }\n\n    (function checkForLibraryExistence() {\n      if ('Hls' in window) {\n        resolve(\n          new window.Hls({\n            testBandwidth: false,\n            abrEwmaDefaultEstimate: 1000000,\n            abrMaxWithRealBitrate: true,\n          })\n        );\n      } else {\n        setTimeout(checkForLibraryExistence, 10);\n      }\n    })();\n  });\n}\n","import React, { useState, useEffect, useRef, FC, HTMLAttributes } from 'react';\nimport { Image, CrystallizeImageVariant } from '@crystallize/react-image';\n\nimport { supportsDash, getDash } from './dash';\nimport { getHls } from './hls';\n\ndeclare global {\n  interface navigator {\n    connection: any;\n  }\n}\n\nexport interface Props extends HTMLAttributes<HTMLDivElement> {\n  playlists: string[];\n  thumbnails?: CrystallizeImageVariant[];\n  thumbnailProps?: object;\n  videoProps?: HTMLAttributes<HTMLVideoElement>;\n  autoPlay?: boolean;\n  loop?: boolean;\n  muted?: boolean;\n  controls?: boolean;\n  poster?: string;\n  playButtonText?: string;\n}\n\n/**\n * Fallback function to get a video poster from the list of\n * variants\n */\nfunction getPoster(thumbnails?: any[]): string | undefined {\n  if (thumbnails && thumbnails.length > 0) {\n    const [firstThumbnail] = thumbnails;\n\n    // Check for naive image props\n    if (firstThumbnail._availableSizes && firstThumbnail._availableFormats) {\n      return firstThumbnail.url;\n    }\n\n    const allVariants = firstThumbnail.variants as CrystallizeImageVariant[];\n\n    const variantsNoFancyStuff = allVariants.filter(\n      (v) => !v.url.endsWith('.webp') && !v.url.endsWith('.avif')\n    );\n\n    return (\n      variantsNoFancyStuff\n        .filter((v) => v.width > 500)\n        .sort((a, b) => a.width - b.width)[0].url || variantsNoFancyStuff[0].url\n    );\n  }\n  return undefined;\n}\n\nexport const Video: FC<Props> = ({\n  playlists,\n  thumbnails,\n  thumbnailProps,\n  videoProps,\n  autoPlay,\n  loop = false,\n  muted = false,\n  controls = true,\n  poster,\n  playButtonText = 'Play video',\n  className,\n}) => {\n  const [showThumbnail, setShowThumbnail] = useState(true);\n  const [playVideo, setPlayVideo] = useState(false);\n  const [initiated, setInitiated] = useState(false);\n  const ref = useRef<HTMLVideoElement>(null);\n\n  /**\n   * Determine if we should auto play the video.\n   * We allow for auto play unless the user has opted\n   * in for saving data\n   */\n  useEffect(() => {\n    if (autoPlay) {\n      const connection = (navigator as any).connection;\n      if (!connection || !connection.saveData) {\n        setPlayVideo(true);\n      }\n    }\n  }, []);\n\n  useEffect(() => {\n    if (!playVideo) {\n      return;\n    }\n\n    if (initiated) {\n      return;\n    }\n\n    const video = ref.current;\n    if (!video) {\n      throw new Error(\n        'Cannot initialize video. Unable to find the video HTML node'\n      );\n    }\n\n    // Hide the thumbnail when the video has started\n    video.addEventListener('playing', () => setShowThumbnail(false), {\n      once: true,\n    });\n\n    const startWithHighQualityVideo = (function () {\n      try {\n        const connection = (navigator as any).connection;\n        return connection.downlink >= 5 && !connection.saveData;\n      } catch (e) {\n        return false;\n      }\n    })();\n\n    /**\n     * Prioritise m3u8\n     */\n    const m3u8Src = playlists.find((p) => p.endsWith('.m3u8'));\n    if (m3u8Src) {\n      /**\n       * iOS has native support for HLS, and we can use\n       * the m3u8 source directly, without the use of hls.js\n       */\n      if (video.canPlayType('application/vnd.apple.mpegurl')) {\n        video.autoplay = true;\n        video.src = m3u8Src;\n\n        setInitiated(true);\n      } else {\n        getHls().then((hls) => {\n          hls.loadSource(m3u8Src);\n          hls.attachMedia(video);\n\n          hls.on('hlsMediaAttached', function () {\n            video.muted = true;\n            video.play();\n          });\n\n          setInitiated(true);\n        });\n      }\n    } else if (supportsDash()) {\n      getDash().then((dashjs) => {\n        const src = playlists.find((p) => p.endsWith('.mpd'));\n        if (!src) {\n          throw new Error('Cannot find a valid Dash source for video');\n        }\n\n        const player = dashjs.MediaPlayer().create();\n\n        player.initialize();\n\n        player.updateSettings({\n          debug: {\n            logLevel:\n              dashjs.Debug.LOG_LEVEL_NONE /* turns off console logging */,\n          },\n          streaming: {\n            abr: {\n              initialBitrate: {\n                audio: -1,\n                video: startWithHighQualityVideo ? 10000 : -1,\n              },\n              autoSwitchBitrate: { audio: true, video: true },\n            },\n          },\n        });\n        player.setAutoPlay(true);\n        player.attachView(video);\n        player.attachSource(src);\n\n        setInitiated(true);\n      });\n    }\n  }, [playVideo]);\n\n  function onPlayClick(event: any) {\n    event.preventDefault();\n    setPlayVideo(true);\n  }\n\n  const thumbnailStyle = {\n    zIndex: showThumbnail ? 2 : 1,\n    opacity: showThumbnail ? 1 : 0,\n  };\n\n  const posterUrl = poster || getPoster(thumbnails);\n\n  return (\n    <div\n      className={`react-video${className ? ` ${className}` : ''}`}\n      style={{ position: 'relative' }}\n    >\n      {thumbnails && thumbnails.length > 0 ? (\n        <Image\n          {...thumbnails[0]}\n          className=\"react-video__thumbnail\"\n          {...thumbnailProps}\n          style={thumbnailStyle}\n        />\n      ) : (\n        <div\n          className=\"react-video__thumbnail-placeholder\"\n          style={thumbnailStyle}\n        />\n      )}\n      {!playVideo && (\n        <button className=\"react-video__play-btn\" onClick={onPlayClick}>\n          {playButtonText}\n          <svg viewBox=\"0 0 100 100\" className=\"react-video__play-icon\">\n            <path d=\"M78.158 51.843L25.842 82.048c-1.418.819-3.191-.205-3.191-1.843v-60.41c0-1.638 1.773-2.661 3.191-1.843l52.317 30.205c1.418.819 1.418 2.867-.001 3.686z\" />\n          </svg>\n        </button>\n      )}\n      <video\n        className=\"react-video__video\"\n        ref={ref}\n        controls={controls}\n        playsInline\n        muted={muted}\n        loop={loop}\n        poster={posterUrl}\n        style={{ opacity: initiated ? 1 : 0, zIndex: showThumbnail ? 1 : 2 }}\n        {...videoProps}\n      />\n    </div>\n  );\n};\n"],"names":["supportsMediaSource","hasWebKit","window","hasMediaSource","supportsDash","added","getDash","Promise","resolve","hlsCore","document","createElement","src","defer","head","appendChild","checkForLibraryExistence","dashjs","setTimeout","getHls","Hls","testBandwidth","abrEwmaDefaultEstimate","abrMaxWithRealBitrate","getPoster","thumbnails","length","firstThumbnail","_availableSizes","_availableFormats","url","allVariants","variants","variantsNoFancyStuff","filter","v","endsWith","width","sort","a","b","undefined","Video","playlists","thumbnailProps","videoProps","autoPlay","loop","muted","controls","poster","playButtonText","className","useState","showThumbnail","setShowThumbnail","playVideo","setPlayVideo","initiated","setInitiated","ref","useRef","useEffect","connection","navigator","saveData","video","current","Error","addEventListener","once","startWithHighQualityVideo","downlink","e","m3u8Src","find","p","canPlayType","autoplay","then","hls","loadSource","attachMedia","on","play","player","MediaPlayer","create","initialize","updateSettings","debug","logLevel","Debug","LOG_LEVEL_NONE","streaming","abr","initialBitrate","audio","autoSwitchBitrate","setAutoPlay","attachView","attachSource","onPlayClick","event","preventDefault","thumbnailStyle","zIndex","opacity","posterUrl","React","style","position","Image","onClick","viewBox","d","playsInline"],"mappings":"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"}